//##################################################
//#
//#           ** DO NOT EDIT THIS FILE **
//#
//##################################################
//# Version: 2023-04-01
'use strict';


const $jwt = require('jsonwebtoken');


//# Set the .exports to the Elmer route function definition
module.exports = function ($app) {
    let $router = $app.app.services.web.router();

    //#
    async function login(oRequest, oResponse, eMode) {
        let a_oUsers, oRS, oConfig, i,
            oJWTConfig = $app.extend(
                {
                    //mode: "jwt",                  //# Inferred by use of this module
                    //realm: "api",                 //# Set below
                    users: [{
                        u: null,
                        p: $app.type.symbol.get()   //# Force the password to be a unique value ensuring login fails if this default config is used
                    }]
                },
                $app.resolve($app.app.config, "security.jwt")
            ),
            bSuccess = false,
            oBody = $app.type.obj.mk(oRequest.body, null),
            oReturnVal = {
                error: 'Incorrect username/password combination.',
                body: oRequest.body
            }
        ;

        //# Ensure the oJWTConfig values are properly set
        oJWTConfig.users = $app.type.arr.mk(oJWTConfig.users, [oJWTConfig.users]);
        oJWTConfig.realm = $app.type.str.mk(oJWTConfig.realm, "api");

        //#
        switch (eMode) {
            case $app.app.enums.userTypes.admin: {
                a_oUsers = oJWTConfig.admin;
                oConfig = {
                    expiresIn: "1 hours",
                    salt: $app.app.config.security.salt.admin
                };
                break;
            }
            case $app.app.enums.userTypes.internal: {
                a_oUsers = oJWTConfig.internal;
                oConfig = {
                    expiresIn: "8 hours",
                    salt: $app.app.config.security.salt.internal
                };
                break;
            }
            case $app.app.enums.userTypes.external: {
                a_oUsers = oJWTConfig.external;
                oConfig = {
                    expiresIn: "8 hours",
                    salt: $app.app.config.security.salt.external
                };
                break;
            }
        }

        //#
        if (oConfig && oBody && $app.type.arr.is(a_oUsers, true)) {
            //# Verify the username/password
            for (i = 0; i < a_oUsers.length; i++) {
                //# If the current .u(sername) and .p(assword) match, set our oUser and fall from the loop
                if ($app.type.obj.is(a_oUsers[i]) &&
                    a_sCreds[1] === a_oUsers[i].u &&
                    a_sCreds[2] === a_oUsers[i].p
                ) {
                    oRS = $app.extend({}, a_oUsers[i]);
                    delete oRS.p;
                    break;
                }
            }
            bSuccess = (oRS !== undefined);

            //# If the username/password was correct
            if (bSuccess) {
                //#
                oReturnVal = $app.extend(oRS, {
                    jwt: $jwt.sign(
                        {
                            username: oRS.username,
                            role: eMode
                        },
                        $app.app.config.security.jwtSecret,
                        {
                            expiresIn: oConfig.expiresIn
                        }
                    )
                });
            }
        }

        oResponse.status(bSuccess ? 200 : 401).json(oReturnVal);
    } //# login


    //# curl -X POST http://localhost:3000/login/verify/admin -H 'Content-Type: application/json' -d '{ "jwt":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNuIiwicm9sZSI6MCwiaWF0IjoxNjQwODQ3NzAwLCJleHAiOjE2NDA4NTEzMDB9.pGwQnctoytxpozWJPVlibkwCv1YauWhckKY7HFuHpC4" }'
    $router.post("/verify/:mode", (oRequest, oResponse) => {
        /*let sSalt;

        //#
        switch ($app.type.str.mk(oRequest.params.mode).toLowerCase()) {
            case "admin": {
                sSalt = $app.app.config.security.salt.admin;
                break;
            }
            case "internal": {
                sSalt = $app.app.config.security.salt.internal;
                break;
            }
            case "external": {
                sSalt = $app.app.config.security.salt.external;
                break;
            }
        }*/

        //#
        oResponse.json(
            $jwt.verify($app.resolve(oRequest.body, "jwt"), $app.app.config.security.jwtSecret)
        );
    }); //# /login/verify

    //# curl -X POST http://localhost:3000/login/admin -H 'Content-Type: application/json' -d '{ "username":"cn", "password":"secret" }'
    $router.post("/admin", async (oRequest, oResponse) => {
        login(oRequest, oResponse, $app.app.enums.userTypes.admin);
    }); //# /login/admin

    //#
    $router.post("/internal", async (oRequest, oResponse) => {
        login(oRequest, oResponse, $app.app.enums.userTypes.internal);
    }); //# /login/internal

    //#
    $router.post("/external", async (oRequest, oResponse) => {
        login(oRequest, oResponse, $app.app.enums.userTypes.external);
    }); //# /login/external

    //#
    $router.post("/app/:baseroute", async (oRequest, oResponse) => {
        //login(oRequest, oResponse, $app.app.enums.userTypes.external);
    }); //# /login/app

    //#
    $router.post("/basic/:baseroute", async (oRequest, oResponse) => {
        //login(oRequest, oResponse, $app.app.enums.userTypes.external);
    }); //# /login/basic

    //#
    $router.post('*', (oRequest, oResponse) => {
        oResponse.status(401).json({
            error: 'Incorrect username/password combination.'
        });
    }); //# /login/*

};
